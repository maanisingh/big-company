version: '3.8'

services:
  # PostgreSQL Database
  postgres:
    image: postgres:15-alpine
    container_name: bigcompany-postgres
    environment:
      POSTGRES_DB: bigcompany
      POSTGRES_USER: bigcompany
      POSTGRES_PASSWORD: bigcompany_secure_2024
    ports:
      - "5434:5432"
    volumes:
      - bigcompany_postgres_data:/var/lib/postgresql/data
      - ./init-db.sql:/docker-entrypoint-initdb.d/init-db.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U bigcompany -d bigcompany"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # Redis for caching and queues
  redis:
    image: redis:7-alpine
    container_name: bigcompany-redis
    ports:
      - "6381:6379"
    volumes:
      - bigcompany_redis_data:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # Blnk Finance - Wallet/Ledger System
  blnk:
    image: jerryenebeli/blnk:latest
    container_name: bigcompany-blnk
    volumes:
      - ./blnk.json:/blnk.json:ro
    ports:
      - "5003:5001"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped

  # Medusa Backend API
  medusa:
    build:
      context: ./medusa-backend
      dockerfile: Dockerfile
    container_name: bigcompany-medusa
    environment:
      DATABASE_URL: postgres://bigcompany:bigcompany_secure_2024@postgres:5432/bigcompany
      REDIS_URL: redis://redis:6379
      JWT_SECRET: bigcompany_jwt_secret_2024_very_secure_production_key
      COOKIE_SECRET: bigcompany_cookie_secret_2024_production_key
      STORE_CORS: https://bigcompany.alexandratechlab.com,http://localhost:3003
      ADMIN_CORS: https://bigcompany-retailer.alexandratechlab.com,https://bigcompany-wholesaler.alexandratechlab.com,http://localhost:3004,http://localhost:3005
      BLNK_API_URL: http://blnk:5001
      NODE_ENV: production
      # Rwanda-specific configuration
      DEFAULT_CURRENCY: RWF
      DEFAULT_COUNTRY: RW
      # Mobile Money Integration
      MOMO_COLLECTION_API_KEY: ${MOMO_COLLECTION_API_KEY:-mtn_collection_api_key}
      MOMO_COLLECTION_USER_ID: ${MOMO_COLLECTION_USER_ID:-mtn_collection_user_id}
      MOMO_DISBURSEMENT_API_KEY: ${MOMO_DISBURSEMENT_API_KEY:-mtn_disbursement_api_key}
      MOMO_DISBURSEMENT_USER_ID: ${MOMO_DISBURSEMENT_USER_ID:-mtn_disbursement_user_id}
      MOMO_SUBSCRIPTION_KEY: ${MOMO_SUBSCRIPTION_KEY:-mtn_subscription_key}
      MOMO_ENVIRONMENT: ${MOMO_ENVIRONMENT:-sandbox}
      # Airtel Money
      AIRTEL_CLIENT_ID: ${AIRTEL_CLIENT_ID:-airtel_client_id}
      AIRTEL_CLIENT_SECRET: ${AIRTEL_CLIENT_SECRET:-airtel_client_secret}
      AIRTEL_ENVIRONMENT: ${AIRTEL_ENVIRONMENT:-sandbox}
      # Africa's Talking (USSD/SMS)
      AT_API_KEY: ${AT_API_KEY:-africas_talking_api_key}
      AT_USERNAME: ${AT_USERNAME:-sandbox}
      AT_SENDER_ID: ${AT_SENDER_ID:-BIGCOMPANY}
      # STS Gas Provider
      STS_API_KEY: ${STS_API_KEY:-sts_api_key}
      STS_VENDOR_ID: ${STS_VENDOR_ID:-sts_vendor_id}
      STS_ENVIRONMENT: ${STS_ENVIRONMENT:-sandbox}
    ports:
      - "9001:9000"
      - "7002:7001"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      blnk:
        condition: service_started
    restart: unless-stopped

  # Customer Storefront (Next.js)
  storefront:
    build:
      context: ./storefront
      dockerfile: Dockerfile
    container_name: bigcompany-storefront
    environment:
      NEXT_PUBLIC_MEDUSA_BACKEND_URL: https://bigcompany-api.alexandratechlab.com
      NEXT_PUBLIC_BLNK_API_URL: https://bigcompany-wallet.alexandratechlab.com
      MEDUSA_BACKEND_URL: http://medusa:9000
      NODE_ENV: production
    ports:
      - "3003:3000"
    depends_on:
      - medusa
    restart: unless-stopped

  # Retailer Dashboard (Refine.dev + Vite)
  retailer-dashboard:
    build:
      context: ./retailer-dashboard
      dockerfile: Dockerfile
    container_name: bigcompany-retailer
    environment:
      VITE_MEDUSA_BACKEND_URL: https://bigcompany-api.alexandratechlab.com
      VITE_BLNK_API_URL: https://bigcompany-wallet.alexandratechlab.com
      VITE_APP_NAME: "BIG Company - Retailer Portal"
      NODE_ENV: production
    ports:
      - "3004:3001"
    depends_on:
      - medusa
    restart: unless-stopped

  # Wholesaler Dashboard (Refine.dev + Vite)
  wholesaler-dashboard:
    build:
      context: ./wholesaler-dashboard
      dockerfile: Dockerfile
    container_name: bigcompany-wholesaler
    environment:
      VITE_MEDUSA_BACKEND_URL: https://bigcompany-api.alexandratechlab.com
      VITE_BLNK_API_URL: https://bigcompany-wallet.alexandratechlab.com
      VITE_APP_NAME: "BIG Company - Wholesaler Portal"
      NODE_ENV: production
    ports:
      - "3005:3002"
    depends_on:
      - medusa
    restart: unless-stopped

volumes:
  bigcompany_postgres_data:
  bigcompany_redis_data:

networks:
  default:
    name: bigcompany-network
